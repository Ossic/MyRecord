# SSH协议

## SSH简介

SSH是英文Secure Shell的简写形式。通过使用SSH，你可以**把所有传输的数据进行加密**，这样"中间人"这种攻击方式就不可能实现了，而且也能够防止DNS欺骗和IP欺骗。使用SSH，还有一个额外的好处就是**传输的数据是经过压缩的**，所以可以加快传输的速度。SSH有很多功能，它既可以代替Telnet，又可以为FTP、Pop、甚至为PPP提供一个安全的"通道"。

## 主机密钥机制

前面的文章提过，SSH进行数据加密采用的是一种非对称加密
SH协议关于主机密钥认证的管理方案有两种：

在第一种方案中，主机将自己的公用密钥分发给相关的客户机，**客户机在访问主机时则使用该主机的公开密钥来加密数据，主机则使用自己的私有密钥来解密数据**，从而实现主机密钥认证，确定客户机的可靠身份。
客户机在发起访问的时候会根据主机名来查找相应的公开密钥。

在第二种方案中，存在一个密钥认证中心，所有系统中**提供服务的主机都将自己的公开密钥提交给认证中心**，而任何作为**客户机的主机则只要保存一份认证中心的公开 密钥就可以了**。在这种模式下，客户机在访问服务器主机之前，还必须向密钥认证中心请求认证，认证之后才能够正确地连接到目的主机上。

上面两种方式各有各的优点与缺点，SSH协议框架中还允许对主机密钥的一个折中处理，那就是**首次访问免认证**。首次访问免认证是指，在某客户机第一次访问主机时，主机不检查主机密钥，**而向该客户都发放一个公开密钥的拷贝**，这样在以后的访问中则必须使用该密钥，否则会被认为非法而拒绝其访问。

## SSH的工作过程

在整个通讯过程中，为实现 SSH的安全连接，服务器端与客户端要经历如下五个阶段：

1. 版本号协商阶段，SSH目前包括 SSH1和SSH2两个版本， 双方通过版本协商确定使用的版本
2. 密钥和算法协商阶段，SSH支持多种加密算法(都属于非对称加密)， 双方根据本端和对端支持的算法，协商出最终使用的算法
3. 认证阶段，SSH客户端向服务器端发起认证请求， 服务器端对客户端进行认证
4. 会话请求阶段， 认证通过后，客户端向服务器端发送会话请求
5. 交互会话阶段 ，会话请求通过后，服务器端和客户端进行信息的交互

## SSH的应用

首先，SSH最常见的应用就是，用它来**取代传统的Telnet、FTP等网络应用程序**，通过SSH登录到远方机器执行你想进行的工作与命令。在不安全的网路通讯环境中，它提供了很强的验证（authentication）机制与非常安全的通讯环境。实际上，SSH开发者的原意是设计它来取代原UNIX系统上的rcp、rlogin、rsh等指令程序的；但经过适当包装后，发现它在功能上完全可以取代传统的Telnet、FTP等应用程序。

## 一些问题

对于基于口令的安全验证的缺点：如果有人冒充服务器，就会给你假服务器公钥，最后就能获得你回应的密码，这就是中间人攻击。

>   SSH基本原理和免密码登录
>
>   从客户端来看,SSH提供两种级别的安全验证：
>   第一种级别是基于口令的安全验证:
>   （1）远程主机收到用户的登录请求，把自己的公钥发给用户。
>   （2）用户使用这个公钥，将登录密码加密后，发送回来。
>   （3）远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。
>
>   第二种级别是基于密匙的安全验证：
>   前提：客户端创建一对公钥+秘钥，同时将公钥放在服务器上。
>   客户端软件就会向服务器发出请求，请求用你的密匙进行安全验证；
>   服务器收到请求之后，先在该服务器上寻找你的公钥，然后把它和你发送过来的公用密匙进行比较。如果两个密匙一致，服务器就用这个公钥加密一个【随机字符串】并把它发送给客户端软件； 3.客户端软件收到【加密后的-随机字符串】之后，就可以用你的私人密匙解密，再把【随机字符串】发送给服务器
>   与第一种级别相比，第二种级别不需要在网络上传送口令。第二种级别不仅加密所有传送的数据，而且“中间人”这种攻击方式也是不可能的（因为他没有你的私人密匙）。但是整个登录的过程可能需要10秒，但是相比输入密码的方式来说10秒也不长。
>
>   来自：https://my.oschina.net/shede333/blog/359290#OSC_h3_8

## 其他

-   关于SSH的版本
    SSH(Secure SHell)到目前为止有两个不兼容的版本——SSH1和SSH2。
    SSH1又分为1.3和1.5两个版本。SSH1采用DES、3DES、 Blowfish和RC4等对称加密算法保护数据安全传输，而对称加密算法的密钥是通过非对称加密算法（RSA）来完成交换的。SSH1使用循环冗余校验码（CRC）来保证数据的完整性，但是后来发现这种方法有缺陷。
    SSH2避免了RSA的专利问题，并修补了CRC的缺陷。SSH2用数字签名算法（DSA）和Diffie-Hellman（DH）算法代替RSA来完成对称密钥的交换，用HMAC来代替CRC。同时SSH2增加了AES和Twofish等对称加密算法。

-   关于公钥私钥补充
    **情况1：公钥用于【加密】， 私钥用于【解密】**
    如果加密密钥是公开的，这用于客户给私钥所有者上传加密的数据，这被称作为公开密钥加密(狭义)。
    例如，网络银行的客户发给银行网站的账户操作的加密数据。HTTPS 等。

    **情况2：公钥用于【解密】，私钥用于【加密】**
    如果解密密钥是公开的，用私钥加密的信息，可以用公钥对其解密，用于客户验证持有私钥一方发布的数据或文件是完整准确的，接收者由此可知这条信息确实来自于拥有私钥的某人，这被称作数字签名，公钥的形式就是数字证书。例如，从网上下载的安装程序，一般都带有程序制作者的数字签名，可以证明该程序的确是该作者（公司）发布的而不是第三方伪造的且未被篡改过（身份认证/验证）。