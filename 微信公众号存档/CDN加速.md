# CDN加速

## 简介

>   **内容分发网络**（**Content delivery network**或**Content distribution network**，缩写：**CDN**）是指一种通过互联网互相连接的电脑网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。

### 优点

内容分发网络的总承载量可以比单一骨干最大的带宽还要大。这使得内容分发网络可以承载的用户数量比起传统单一服务器多。也就是说，若把有100Gbps处理能力的服务器放在只有10Gbps带宽的数据中心，则亦只能发挥出10Gbps的承载量。但如果放到十个有10Gbps的地点，整个系统的承载量就可以到10*10Gbps。

同时，将服务器放到不同地点，可以减少互连的流量，进而降低带宽成本。

对于TCP传输而言，TCP的速度（throughput）会受到延迟时间（latency）与数据包漏失率（packet loss）影响。为了改善这些负面因素，**内容分发网络通常会指派较近、较顺畅的服务器节点将数据传输给用户**。虽然距离并不是绝对因素，但这么做可以尽可能提高性能，用户将会觉得比较顺畅。这使得一些比较高带宽的应用（传输高清画质的视频）更容易推动。

内容分发网络另外一个好处在于有异地备援。当某个服务器故障时，系统将会调用其他邻近地区的服务器服务，进而提供接近100%的可靠度。

除此之外，内容分发网络提供给服务提供者更多的控制权。提供服务的人可以针对客户、地区，或是其他因子调整。

>   **CDN简单的来说就是存储一些*静态文件*的一台或多台服务器，通过复制，缓存等方式，将文件保存其中。**
>
>   用户访问使用了CDN技术的网站会被解析到离其最近(地理位置)的缓存服务器，进而加快访问速度和分担主服务器的压力

## 快速了解CDN

上面我们提到CDN服务器主要是缓存静态文件进行加速的，那么......

### 什么是静态文件

css，html，图片，媒体都属于静态文件，也就是说用户发送的请求不会影响静态文件的内容，而jsp，php等文件就不属于静态文件，因为他们的内容会因我们的请求而发生改变。

### CDN如何实现加速

通常情况下，我们所要的数据都是从主服务器中获取，但假如我们的主服务器在南方，而访问用户在北方，那么访问速度就会相对变慢，变慢的原因有很多，例如传输距离，运营商，带宽等等因素，而使用CDN技术的话，我们会将CDN节点分布在各地，当用户发送请求到达服务器时，服务器会根据用户的区域信息，为用户分配最近的CDN服务器。

一般CDN服务器是分类的，有的专门用于网页加速，有的是文件(下载服务)加速，还有的是对媒体加速等

### 数据从哪来？

**复制，缓存**，CDN服务器可以在用户请求后缓存文件，也可以主动抓取主服务器内容。

### 为什么使用CDN

从上面的如何实现加速也可以看出，速度是很大一方面原因，也与服务器压力有一定关系
影响网络传输的四个因素：

1.  “第一公里”：网站服务器接入互联网的链路所能提供的带宽。
2.  “最后一公里”：用户接入带宽。
3.  对等互联关口：不同网络之间的互联互通带宽。
4.  长途骨干传输：首先是长距离传输时延问题，其次是骨干网拥塞问题

## 引入CDN后的访问流程

①  当用户点击网站页面上的内容URL，经过本地DNS系统解析，DNS会最终将域名的解析权交给**CNAME指向的CDN专用DNS服务器。**

②  CDN的DNS服务器将CDN的全局负载均衡设备IP地址返回用户。

③  用户向CDN的全局负载均衡设备发起内容URL访问请求。

④  CDN全局负载均衡设备根据用户IP地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。

⑤  区域负载均衡设备会为用户选择一台合适的缓存服务器提供服务。选择的依据包括:根据用户IP地址，判断哪一台服务器距离用户最近；根据用户请求的URL携带的内容名称，判断哪一台服务器上有用户所需内容；查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。基于以上这些条件的综合分析后，区域负载均衡设备会向全局负载均衡设备返回一台缓存服务器的IP地址。

⑥  全局负载均衡设备把IP地址返回用户。

⑦  用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域负载均衡设备依然将它分配给了用户，那么这一台服务器要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。