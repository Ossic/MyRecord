# 缓冲区溢出

## 什么是缓冲区溢出

引用 Wiki 上的一段，感觉写的还是比较好的

>   缓冲区溢出（buffer overflow），**是针对程序设计缺陷，向程序输入缓冲区写入使之溢出的内容（通常是超过缓冲区能保存的最大数据量的数据），从而破坏程序运行、并获取程序乃至系统的控制权。**

缓冲区溢出**原指**当某个数据超过了处理程序限制的范围时，程序出现的异常操作。造成此现象的原因有：

-   存在缺陷的程序设计。
-   尤其是 C 语言，不像其他一些高级语言会自动进行数组或者指针的边界检查，增加溢出风险。
-   C 语言中的 C 标准库还具有一些非常危险的操作函数，使用不当也为溢出创造条件。

后因黑客在 Unix 的内核发现通过缓冲区溢出**可以获得系统的最高等级权限**，而成为攻击手段之一。

也有人发现相同的问题也会出现在 Windows 操作系统上，以致其成为黑客最为常用的攻击手段，蠕虫病毒利用操作系统高危漏洞进行的破坏与大规模传播均是利用此技术。

比较知名的蠕虫病毒冲击波蠕虫，就基于 Windows 操作系统的缓冲区溢出漏洞。

## 简单介绍原理

缓冲区溢出的含义简单理解就是**为缓冲区提供了多于其存储容量的数据**，就像往杯子里倒入了过量的水一样。

通常情况下，缓冲区溢出的数据只会破坏程序数据，造成意外终止。

但是如果有人精心构造溢出数据的内容，那么就有可能获得系统的控制权！如果说用户（也可能是黑客）提供了水——缓冲区溢出攻击的**数据**，那么系统提供了溢出的容器——缓冲区。

**缓冲区溢出会出现在和用户输入相关缓冲区内，在一般情况下，这已经变成了现代计算机和网络方面最大的安全隐患之一。**

总之还是那句话：不要太相信用户输入的数据

---

缓冲区在系统中的表现形式是多样的，高级语言定义的**变量、数组、结构体等在运行时可以说都是保存在缓冲区内的**，因此所谓缓冲区可以更抽象地理解为**一段可读写的内存区域**

缓冲区攻击的最终目的就是希望系统能执行这块可读写内存中已经被蓄意设定好的恶意代码。按照冯·诺依曼存储程序原理，程序代码是作为二进制数据存储在内存的，同样程序的数据也在内存中，因此直接从内存的二进制形式上是无法区分哪些是数据哪些是代码的，这也为缓冲区溢出攻击提供了可能。

上图是进程地址空间分布的简单表示。代码存储了用户程序的所有可执行代码，**在程序正常执行的情况下，程序计数器（PC指针）只会在代码段和操作系统地址空间（内核态）内寻址。**

**数据段**内存储了用户程序的全局变量，文字池等。

**栈空间**存储了用户程序的函数栈帧（包括参数、局部数据等），实现函数调用机制，它的数据增长方向是低地址方向。

**堆空间**存储了程序运行时动态申请的内存数据等，数据增长方向是高地址方向。（也就是说增长方向就是图中箭头的方向）

除了**代码段**和**受操作系统保护的数据区域**，其他的内存区域都可能作为缓冲区，因此缓冲区溢出的位置可能在**数据段**，也可能在**堆、栈段**。

如果程序的代码有软件漏洞，恶意程序会“教唆”程序计数器从上述缓冲区内取址，执行恶意程序提供的数据代码！

## 利用

例如一个用途是对 SONY 的掌上游戏机 PSP-3000 的破解，通过特殊的溢出图片，PSP 可以运行非官方的程序与游戏。

同样在诺基亚智能手机操作系统 Symbian OS 中发现漏洞用户可以突破限制运行需要 DRM 权限或文件系统权限等系统权限的应用程序。

**缓冲区溢出攻击从理论上来讲可以用于攻击任何有相关缺陷的程序，包括对杀毒软件、防火墙等安全产品的攻击以及对银行程序的攻击。**

在嵌入式设备系统上也可能被利用，例如 PSP、智能手机等。

在部分情况下，当一般程序（除了驱动和操作系统内核）发生此类问题时，C++运行时库通常会终止程序的执行。

## 操作系统层级的保护

目前 OpenBSD、Linux、Windows、Mac OS 等操作系统都具有 buffer overflow protection（缓存溢出保护/存储器位置重新定向）功能，在某种程度上可以**保护操作系统**，但仍还是有办法让溢出的代码到“正确”的位置上。

其是作原理是：存储器跟进程在 memory 中受到保护。内对外的 access memory 对象位置会被核心（调度器）随机定向，使其无法正确溢出。

## 最后

如果想要更深入的了解最好是会点 C/C++ 或者汇编相关的知识，最好还了解过逆向，可惜我一项条件都不具备，只能放弃深入了

如果周围有打 CTF 的大佬那必定它们很熟了....

深入资料：
http://www.cnblogs.com/fanzhidongyzby/p/3250405.html
http://www.freebuf.com/articles/system/40107.html
看雪的《0day安全：软件漏洞分析技术》一书